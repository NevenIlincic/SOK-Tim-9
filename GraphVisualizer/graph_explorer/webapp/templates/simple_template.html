{% extends "base.html" %} {% load static %} {% block mainView %}
<h1 class="text-center">Main view</h1>

<div id="graph" style="background-color: gray;"></div>

<!-- D3.js -->
<script src="https://d3js.org/d3.v7.min.js"></script>

<script>
    // Podaci koje Django ubacuje
    window.nodes = {{ nodes | safe }};
    window.edges = {{ edges | safe }};
    const width = 1300;
    const height = 650;

    // --- Main graph ---
    const simulation = d3.forceSimulation(nodes)
        .force("link", d3.forceLink(edges).id(d => d.id).distance(150))
        .force("charge", d3.forceManyBody().strength(-400))
        .force("center", d3.forceCenter(width / 2, height / 2));

    const svg = d3.select("#graph")
        .append("svg")
        .attr("width", width)
        .attr("height", height);

    const g = svg.append("g");

    const link = g.append("g")
        .attr("stroke", "#aaa")
        .selectAll("line")
        .data(edges)
        .enter().append("line")
        .attr("stroke-width", 2);

    const node = g.append("g")
        .attr("stroke", "#fff")
        .attr("stroke-width", 1.5)
        .selectAll("circle")
        .data(nodes)
        .enter().append("circle")
        .attr("r", 30)
        .attr("fill", "#4CAF50")
        .call(drag(simulation));

    const labels = g.append("g")
        .selectAll("text")
        .data(nodes)
        .enter().append("text")
        .attr("dy", 4)
        .attr("text-anchor", "middle")
        .text(d => d.properties.id)
        .style("font-size", "12px")
        .style("fill", "#fff");

    const zoom = d3.zoom()
        .scaleExtent([0.2, 4])
        .on("zoom", (event) => {
            g.attr("transform", event.transform);   // move main graph
            if (window.updateBirdView) {
                window.updateBirdView();           // update red rectangle
            }
        });

    svg.call(zoom);
    // Tooltip
    const tooltip = d3.select("body")
        .append("div")
        .style("position", "absolute")
        .style("background-color", "rgba(0,0,0,0.8)")
        .style("color", "#fff")
        .style("padding", "8px")
        .style("border-radius", "4px")
        .style("pointer-events", "none")
        .style("opacity", 0);

    simulation.on("tick", () => {
        // Main graph update
        link
            .attr("x1", d => d.source.x)
            .attr("y1", d => d.source.y)
            .attr("x2", d => d.target.x)
            .attr("y2", d => d.target.y);

        node
            .attr("cx", d => d.x)
            .attr("cy", d => d.y);

        labels
            .attr("x", d => d.x)
            .attr("y", d => d.y);

        window.updateBirdView();
    });

    node.on("mouseover", (event, d) => {
        tooltip.transition().duration(200).style("opacity", 1);
        let content = `<strong>ID:</strong> ${d.properties.id}<br>`;
        for (const key in d.properties) {
            if (key !== "id") content += `<strong>${key}:</strong> ${d.properties[key]}<br>`;
        }
        tooltip.html(content)
            .style("left", (event.pageX + 10) + "px")
            .style("top", (event.pageY + 10) + "px");
    })
        .on("mousemove", (event) => {
            tooltip.style("left", (event.pageX + 10) + "px")
                .style("top", (event.pageY + 10) + "px");
        })
        .on("mouseout", () => {
            tooltip.transition().duration(200).style("opacity", 0);
        });

    function drag(simulation) {
        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }
        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }
        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }
        return d3.drag()
            .on("start", dragstarted)
            .on("drag", dragged)
            .on("end", dragended);
    }
</script>
{% endblock %}

{% block birdView %}
<div id="bird-view" style="width:100%; height:100%; border:1px solid #ccc; background:#f9f9f9;">
</div>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script>
    function waitForMainGraph() {
        if (window.nodes && window.edges) {
            initBirdView();   // safe to build bird-view now
        } else {
            setTimeout(waitForMainGraph, 50); // check again in 50ms
        }
    }
    waitForMainGraph();

    function initBirdView() {
        const birdDiv = document.getElementById('bird-view');

        window.birdWidth = birdDiv.clientWidth;
        window.birdHeight = birdDiv.clientHeight;
        const birdSvg = d3.select("#bird-view")
            .append("svg")
            .attr("width", window.birdWidth)
            .attr("height", window.birdHeight);

        const birdG = birdSvg.append("g");

        window.birdLinks = birdG.append("g")
            .attr("stroke", "#aaa")
            .selectAll("line")
            .data(window.edges)
            .enter().append("line")
            .attr("stroke-width", 1);

        window.birdNodes = birdG.append("g")
            .selectAll("circle")
            .data(window.nodes)
            .enter().append("circle")
            .attr("r", 3)
            .attr("fill", "#4CAF50");

        window.birdViewport = birdSvg.append("rect")
            .attr("fill", "none")
            .attr("stroke", "red")
            .attr("stroke-width", 1);
    }

    window.updateBirdView = function () {
        // Bird view update
        if (window.birdLinks && window.birdNodes) {
            const transform = d3.zoomTransform(svg.node()); // get current zoom + pan

            const xExtent = d3.extent(window.nodes, d => d.x);
            const yExtent = d3.extent(window.nodes, d => d.y);

            const graphWidth = xExtent[1] - xExtent[0];
            const graphHeight = yExtent[1] - yExtent[0];

            // choose same scale for both axes (to preserve distances)
            const scale = Math.min(
                window.birdWidth / graphWidth,
                window.birdHeight / graphHeight
            );

            // offsets so it's centered
            const offsetX = (window.birdWidth - graphWidth * scale) / 2;
            const offsetY = (window.birdHeight - graphHeight * scale) / 2;

            function scaleX(x) {
                return (x - xExtent[0]) * scale + offsetX;
            }
            function scaleY(y) {
                return (y - yExtent[0]) * scale + offsetY;
            }

            const viewX = scaleX(-transform.x / transform.k);
            const viewY = scaleY(-transform.y / transform.k);
            const viewWidth = window.birdWidth / transform.k * scale;
            const viewHeight = window.birdHeight / transform.k * scale;

            window.birdLinks
                .attr("x1", d => scaleX(d.source.x))
                .attr("y1", d => scaleY(d.source.y))
                .attr("x2", d => scaleX(d.target.x))
                .attr("y2", d => scaleY(d.target.y));

            window.birdNodes
                .attr("cx", d => scaleX(d.x))
                .attr("cy", d => scaleY(d.y));

            window.birdViewport
                .attr("x", viewX)
                .attr("y", viewY)
                .attr("width", viewWidth)
                .attr("height", viewHeight);

        }
    }
</script>
{% endblock %}