<div id="modern-terminal-container">
  <div class="terminal-header">
    <span class="terminal-title">TERMINAL</span>
  </div>
  <div class="terminal-body">
    <div class="terminal-output">
      <span class="start-text">Modern Graph Visualizer Terminal.</span>
      <span class="start-text">Unesite komandu za početak...</span>
    </div>
    <div class="terminal-input-wrapper">
      <span class="prompt"> > </span>
      <input type="text" class="terminal-input">
    </div>
  </div>
  <div style="display: none;">
    <form id="hiddenFilterForm" method="post" action="{% url 'query_filter' %}">
      {% csrf_token %}
      <input type="hidden" name="filter">
      <input type="hidden" name="relations">
      <input type="hidden" name="value">
    </form>
  </div>
</div>
<script>
  const terminalOutput = document.querySelector('.terminal-output');
  const terminalInput = document.querySelector('.terminal-input');
let commandHistory = JSON.parse(sessionStorage.getItem('terminalHistory')) || [];

  document.addEventListener('DOMContentLoaded', function () {
    if (commandHistory.length > 0) {
      commandHistory.forEach(element => {
        appendLine(element, true)
      });
    }
  });

  function appendLine(text, isCommand = false) {
    const line = document.createElement('div');
    line.innerHTML = `<span class="prompt">${isCommand ? '> ' : ''}</span><span class="line-text">${text}</span>`;
    terminalOutput.appendChild(line);
    terminalOutput.scrollTop = terminalOutput.scrollHeight;
  }

  terminalInput.addEventListener('keydown', function (event) {
    if (event.key === 'Enter') {
      const command = this.value.trim();
      if (command !== '') {
        appendLine(command, true);
        commandHistory.push(command);
        sessionStorage.setItem('terminalHistory', JSON.stringify(commandHistory));
        this.value = '';

        const filterMatch = command.match(/^filter\s+(.+?)(<|>|<=|>=|=)(.+)$/);
        const createNodeMatch = command.startsWith('create node');

        if (filterMatch) {
         filterGraph(command, filterMatch);
        }else if(createNodeMatch){
          createNode(command);
        }
         else {
          appendLine('Nepoznata komanda.', false);
          commandHistory.push('Nepoznata komanda.');
          sessionStorage.setItem('terminalHistory', JSON.stringify(commandHistory));

        }
      }
    }
  });

  window.addEventListener('load', function () {
    terminalInput.focus();
  });

  function filterGraph(command, filterMatch){
     const [, attribute, relation, value] = filterMatch;
          const form = document.getElementById('hiddenFilterForm');

          form.querySelector('[name="filter"]').value = attribute;
          form.querySelector('[name="relations"]').value = relation;
          form.querySelector('[name="value"]').value = value;

          form.submit();
  }
  function createNode(command) {
      const idMatch = command.match(/--id=(\S+)/);
      const propertiesMatches = command.matchAll(/--property\s+([^=\s]+)=([\S]+)/g);
      console.log('Matches: ', propertiesMatches);

      const nodeId = idMatch ? idMatch[1] : null;
      const properties = {};

      if (idMatch && propertiesMatches) {
        for (const match of propertiesMatches) {
          const key = match[1];
          let value = match[2];
          console.log('key: ', key);
          console.log('value', value);

          if (value.toLowerCase() === 'true') {
            value = true;
          } else if (value.toLowerCase() === 'false') {
            value = false;
          }
          else if (!isNaN(Number(value))) {
            value = Number(value);
          }
          else if (!isNaN(new Date(value)) && !isNaN(Date.parse(value))) {
            value = new Date(value);
          }

          properties[key] = value;
        }
        call_create_node_api(nodeId, properties);
      }else{
        appendLine('Neispravan unos atributa');
        commandHistory.push('Neispravan unos atributa');
        sessionStorage.setItem('terminalHistory', JSON.stringify(commandHistory));
      }

console.log('Node ID:', nodeId);
console.log('Properties:', properties);
}
async function call_create_node_api(nodeId, properties) {
    try {
        const response = await fetch('/create_node/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                id: nodeId,
                properties: properties
            }),
        });

        const result = await response.json();

        if (response.ok) {
            appendLine(`Čvor sa ID-jem '${nodeId}' uspešno kreiran.`);
            commandHistory.push(`Čvor sa ID-jem '${nodeId}' uspešno kreiran.`);
        } else {
            appendLine(`Greška prilikom kreiranja čvora: ${result.message}`);
            commandHistory.push(`Greška prilikom kreiranja čvora: ${result.message}`);
        }
        sessionStorage.setItem('terminalHistory', JSON.stringify(commandHistory));

    } catch (error) {
        appendLine(`Greška u komunikaciji: ${error.message}`);
        commandHistory.push(`Greška u komunikaciji: ${error.message}`);
        sessionStorage.setItem('terminalHistory', JSON.stringify(commandHistory));
    }
}
</script>